version: 2

jobs:
  compute-version:
    docker:
      - image: alpine
    steps:
      - checkout
      - run:
          name: Compute a version designator and write it to a text file
          command: echo "0.0.${CIRCLE_BUILD_NUM}-${CIRCLE_SHA1:0:7}" > version.txt
      - persist_to_workspace:
          root: ./
          paths:
            - ./

  server-install-dependencies:
    docker:
      - image: node:current-alpine
    steps:
      - attach_workspace:
          at: ./
      - restore_cache:
          keys:
            - yarn-deps-{{ checksum "server/yarn.lock" }}
            - yarn-deps
      - run:
          name: Install dependencies
          command: yarn install
          working_directory: server
      - save_cache:
          paths:
            - server/node_modules
          key: yarn-deps-{{ checksum "server/yarn.lock" }}
      - store_artifacts:
          path: server/yarn.lock
      - persist_to_workspace:
          root: ./
          paths:
            - ./

  server-build-production:
    docker:
      - image: node:current-alpine
    steps:
      - attach_workspace:
          at: ./
      - run:
          name: Production build
          command: |
            export DECODE_BUILD_VERSION=$(cat ../version.txt)
            yarn build
          working_directory: server
      - store_artifacts:
          path: server/dist/server.js
      - persist_to_workspace:
          root: ./
          paths:
            - ./

  server-test:
    docker:
      - image: node:current-alpine
    parallelism: 2
    steps:
      - attach_workspace:
          at: ./
      - run:
          name: Run tests
          command: |
            circleci tests glob '**/*.test.ts' | circleci tests split --split-by timings | xargs yarn test:ci
          working_directory: server
      - store_artifacts:
          path: server/test-results
      - store_test_results:
          path: server/test-results

workflows:
  version: 2
  build-test-deploy-server:
    jobs:
      - compute-version
      - server-install-dependencies:
          requires:
            - compute-version
      - server-build-production:
          requires:
            - server-install-dependencies
      - server-test:
          requires:
            - server-install-dependencies
      - server-deploy-approval:
          type: approval
          requires:
            - server-build-production
            - server-test

  build-test-deploy-client:
    jobs:
      - compute-version
